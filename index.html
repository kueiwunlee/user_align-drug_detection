<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>藥物辨識</title>
    <script src="jquery.js"></script>
    <style>
        h1,
        h2,
        h3,
        h5,
        h6,
        div {
            font-family: 微軟正黑體;
            text-align: center;
        }

        .slider {
            -webkit-appearance: none;
            width: 380px;
            height: 15px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>藥物辨識</h1>
    <h3>步驟一:輸入藥上的特徵</h3>
    <h5>不分英數、大小寫、順序、正反面、刻痕</h5>
    <div>
        <input style="width: 300px;" placeholder="ex: 刻痕(-)、十字刻痕(+)">
    </div><br>
    <h3>步驟二:選顏色(預設:白)</h3>
    <div>
        <input type="radio" name="white_drug" value="white" checked>白色<br>
        <input id="notwhite" type="radio" name="white_drug">下方選顏色
        <canvas id="color_pick" width="30" height="30"></canvas><br>
        <canvas id="color_bar" width="360" height="30"></canvas><br>
        <input id="saturation_bar" class="slider" type="range" min="1" max="360" value="50"
            onchange="document.getElementById('notwhite').checked=true;"><br>
        色調: <a id="degree">50</a><sup>o</sup><br>
        <button>初步搜尋</button><br>
    </div>
    <hr>
    <h5>初步搜尋結果:</h5>
    <ul id="show_pred" style="list-style:none;">
        <li id="top0">尚未搜尋</li>
    </ul>
    <h6>若搜尋不到請至下方第三步</h6>
    <hr>
    <h3>步驟三:標記藥品位置</h3>
    <div>
        <button onclick="initCameraStream();">開啟鏡頭</button><br>
        <video id="streamvideo" class="videostream" autoplay playsinline></video><br>
        <button onclick="take_canvas();">藥品置中照一張</button><br>
        <canvas></canvas><br>
        <button>深度搜尋</button><br>
    </div>
    <hr>
    <h5>深度搜尋結果:</h5>
    <ul id="show_pred_deep" style="list-style:none;">
        <li id="deep_top0">尚未搜尋</li>
    </ul>
    <script type="text/javascript">
        var c = document.getElementById("color_bar");
        var ctx = c.getContext("2d");
        var color_bar_width = 360;
        var color_bar_height = 30;
        // 建立線型漸層物件 參數依序為 x0(x起始點)、y0(y起始點)、x1(x結束點)、y1(y結束點)
        var grd = ctx.createLinearGradient(0, 0, color_bar_width, color_bar_height);
        // 設定顏色位置 參數依序為 position(0.0 到 1.0，0 即為起始點，1 即為結束點)、顏色代碼
        grd.addColorStop(0, "rgb(255,0,0)");
        grd.addColorStop(0.08, "rgb(255,128,0)");
        grd.addColorStop(0.17, "rgb(255,255,0)");
        grd.addColorStop(0.25, "rgb(128,255,0)");
        grd.addColorStop(0.33, "rgb(0,255,0)");
        grd.addColorStop(0.42, "rgb(0,255,128)");
        grd.addColorStop(0.5, "rgb(0,255,255)");
        grd.addColorStop(0.58, "rgb(0,128,255)");
        grd.addColorStop(0.67, "rgb(0,0,255)");
        grd.addColorStop(0.75, "rgb(128,0,255)");
        grd.addColorStop(0.83, "rgb(255,0,255)");
        grd.addColorStop(1, "rgb(255,0,128)");
        // 設定填滿樣式
        ctx.fillStyle = grd;
        // 執行填滿繪製 參數依序為 x、y、width(寬)、height(高)
        ctx.fillRect(0, 0, color_bar_width, color_bar_height);

        var slider = document.getElementById("saturation_bar");
        var output = document.getElementById("degree");
        var color_picked = document.getElementById("color_pick");
        slider.oninput = function () {
            output.innerHTML = this.value;
            cs = this.value;
            r = ctx.getImageData(cs - 1, 0, cs, 1).data[0];
            g = ctx.getImageData(cs - 1, 0, cs, 1).data[1];
            b = ctx.getImageData(cs - 1, 0, cs, 1).data[2];
            color_picked.style.backgroundColor = "rgb(" + r + "," + g + "," + b + ")";
        }

        const video = document.querySelector('#streamvideo');
        function initCameraStream() {
            video.style = "";
            var constraints = {
                audio: false,
                video: {
                    width: { min: 300, ideal: window.innerWidth, max: 500 },
                    height: { min: 300, ideal: window.innerWidth, max: 500 },
                    facingMode: 'environment'
                }
            };
            navigator.mediaDevices.getUserMedia(constraints).
                then(handleSuccess).catch(handleError);
            function handleSuccess(stream) {
                window.stream = stream; // make stream available to browser console
                video.srcObject = stream;
                if (constraints.video.facingMode) {
                    return navigator.mediaDevices.enumerateDevices(); //enumerateDevices  getUserMedia
                }
            }
            function handleError(error) {
                console.log(error);
                if (error === 'PermissionDeniedError') {
                    alert("Permission denied. Please refresh and give permission.");
                }
            }
        }
        function take_canvas() {
            video.style = "visibility:hidden;height:0px;width:0px;";
            if (window.stream) {
                window.stream.getTracks().forEach(function (track) {
                    track.stop();
                });
            }
        }

        function search() {
            var ul = document.getElementById("show_pred");
            for (i = 0; i < rank.length; i++) {
                if (document.getElementById("top" + i)) {
                    var element = document.getElementById("top" + i);
                    element.parentNode.removeChild(element);
                }
                var li = document.createElement("li");
                li.setAttribute("id", "top" + i);
                ul.appendChild(li);
                document.getElementById("top" + i).innerHTML = "<img src='drug_pic64x64/" + class_name_dict[rank[i]] + "'>" + class_name_dict[rank[i]];
            }
        }
    </script>
    <div class="demo">
        <!-- 調整色彩 -->
        <div class="color">
            R<input id="red" type="range" name="points" min="0" max="255" value="0"><br>
            G<input id="green" type="range" name="points" min="0" max="255" value="0"><br>
            B<input id="blue" type="range" name="points" min="0" max="255" value="0">
        </div>
        <div class="value">
            R<input id="vred" type="text" value="0">
            G<input id="vgreen" type="text" value="0">
            B<input id="vblue" type="text" value="0">
        </div>
        <!-- 調整色彩end -->
        <!-- Canvas -->
        <canvas id="canvas" width="400" height="400" style="border: thick solid black;">
            Sorry, your browser doesn't support the &lt;canvas&gt; element.
        </canvas>
        <!-- Canvas end -->
    </div>
    <script type="text/javascript">
        var _canvas = document.getElementById('canvas');
        var ctx = _canvas.getContext('2d');  
    
        $('.color input').change(function(){
            r = $('#red').val();
            g = $('#green').val();
            b = $('#blue').val();
            changeColor(r,g,b);
            //取出input中的數值
        });
    
        function changeColor(r,g,b){
            colors = {
                red : r,
                green : g,
                blue : b
            }
            $.each(colors, function(_color, _value) {
                $('#v'+_color).val(_value);
            });
            ctx.strokeStyle = "rgb("+r+","+g+","+b+")" ;
            //將顏色的值寫到ctx.strokeStyle即可
        };
    
        var x = 0;
        var y = 0;
    
        function getMousePos(canvas, evt) {
            var rect = canvas.getBoundingClientRect();
            //getBoundingClientRect 取得物件完整座標資訊，包含寬高等
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };   
        //這個function將會傳回滑鼠在 _canvas上的座標
        };
    
        function mouseMove(evt) {
            var mousePos = getMousePos(_canvas, evt);
            //透過getMousePos function 去取得滑鼠座標
            //mousePos 是一個物件，包含x和y的值
            ctx.lineTo(mousePos.x, mousePos.y);
            //利用取回的值畫線
            ctx.stroke();
            //畫!
        };
    
        canvas.addEventListener('ontouchstart', function(evt) {
            var mousePos = getMousePos(_canvas, evt);
            //從按下去就會執行第一次的座標取得
            evt.preventDefault();
            ctx.beginPath();
            //建立path物件
            ctx.moveTo(mousePos.x, mousePos.y);  
            //每次的點用moveTo去區別開，如果用lineTo會連在一起  
            canvas.addEventListener('ontouchmove', mouseMove, false);
            //mousemove的偵聽也在按下去的同時開啟
        });
    
        canvas.addEventListener('ontouchhend', function() {
            canvas.removeEventListener('ontouchmove', mouseMove, false);
        }, false);
        //如果滑鼠放開，將會停止mouseup的偵聽
    </script>
</body>

</html>